

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hacking &mdash; odk_planner v0.11 documentation</title>
  

  
  

  
  <link href='_static/fonts.css' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="odk_planner v0.11 documentation" href="index.html"/>
        <link rel="next" title="Testing" href="testing.html"/>
        <link rel="prev" title="Tutorial" href="tutorial.html"/> 

  
  <script src="_static/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> odk_planner</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#features">Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installing.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing.html#get-odk-planner">Get odk_planner</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing.html#setup-instance">Setup instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing.html#installing-cron-job">Installing cron job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuring.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#settings-sheet"><tt class="docutils literal"><span class="pre">settings</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#users-sheet"><tt class="docutils literal"><span class="pre">users</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#overview-sheet"><tt class="docutils literal"><span class="pre">overview</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#colors-sheet"><tt class="docutils literal"><span class="pre">colors</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#cron-sheet"><tt class="docutils literal"><span class="pre">cron</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#sms-sheet"><tt class="docutils literal"><span class="pre">sms</span></tt> sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html#more-sheets">More sheets</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using.html#uploading-form-template">Uploading form template</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#overview-entered-forms">Overview entered forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#viewing-data">Viewing data</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#sending-sms">Sending SMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#automatization">Automatization</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#log-files">Log files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tools.html#utility-scripts">Utility scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html#labeler">Labeler</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html#odk-pusher">ODK pusher</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html#xray-uploader">Xray uploader</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html#ms-sql-uploader">MS-SQL uploader</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#demo-project-description">Demo Project Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#initial-setup-of-odk-planner-and-odk-aggregate">Initial setup of <tt class="docutils literal"><span class="pre">odk_planner</span></tt> and ODK Aggregate</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#setting-up-the-project">Setting up the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#uploading-the-forms">Uploading the forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#check-out-the-overview">Check out the overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#viewing-data">Viewing data</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial.html#solutions">Solutions</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Hacking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#globals-and-utilities">Globals and Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-the-database">Accessing the Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developing-a-plugin">Developing a Plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="privacy.html">About Privacy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="privacy.html#digitization">Digitization</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy.html#database-segregation">Database segregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy.html#admin-rights">Admin rights</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy.html#choosing-a-good-password">Choosing a good password</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="aggregate.html">Questions &amp; Answers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="aggregate.html#odk-aggregate-database-settings">ODK Aggregate database settings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">odk_planner</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Hacking</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/hacking.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="hacking">
<span id="id1"></span><h1>Hacking<a class="headerlink" href="#hacking" title="Permalink to this headline">¶</a></h1>
<p>I&#8217;m not a fan of PHP. The language has <a class="reference external" href="http://eev.ee/blog/2012/04/09/php-a-fractal-of-bad-design/">many shortcomings</a> that make it
difficult to write nicely encapsulated code. I didn&#8217;t even try but started the
project with one big <tt class="docutils literal"><span class="pre">index.php</span></tt> file that included everything, and then
refractored some code later on into separate <tt class="docutils literal"><span class="pre">.php</span></tt> files to prevent the file
from bloating above 1000 lines of code.</p>
<div class="section" id="overview">
<span id="hacking-overview"></span><h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The file <tt class="docutils literal"><span class="pre">index.php</span></tt> contains all the logic and structured into the following
sections (<a class="reference external" href="http://www.vim.org/download.php">VIM</a> can expand/collapse the corresponding code folds).</p>
<ol class="arabic simple">
<li>Pre-initialization, includes : Things common to all
<a class="reference internal" href="installing.html#install-instance"><em>instances</em></a>.</li>
<li>Set up instance : Find out form cookies or parameters which instance should
be used and set up paths accordingly.</li>
<li>Load configuration from <tt class="docutils literal"><span class="pre">config.xls</span></tt> into global <tt class="docutils literal"><span class="pre">$user</span></tt>. See file
<tt class="docutils literal"><span class="pre">config.php</span></tt>.</li>
<li>Login: Show the login box if the user is not currently logged in and compare
username and password to configuration options during login action. Then
load user information (access rights etc) into global <tt class="docutils literal"><span class="pre">$user</span></tt>.</li>
<li>Connect to database, load forms. The excel forms from the directory
<tt class="docutils literal"><span class="pre">instances/XXX/forms</span></tt> are loaded and compared with the local ODK database.
See file``odk_form.php``.</li>
<li>Actions : Do stuff, such as file upload or download. Note that so far no
HTML output has been generated (if the user is logged in).</li>
<li>Start HTML output</li>
<li>Show the menu, depending on user&#8217;s access rights.</li>
<li>Display : Generate the main output<ol class="loweralpha">
<li><tt class="docutils literal"><span class="pre">show=overview</span></tt> : Show the tabular overview over all data contained
in the database. See <tt class="docutils literal"><span class="pre">overview.php</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">show=form</span></tt> : Show the content of a form</li>
<li><tt class="docutils literal"><span class="pre">show=forms</span></tt> : List the contents of the <tt class="docutils literal"><span class="pre">instances/XXX/forms</span></tt>
directory.</li>
<li><tt class="docutils literal"><span class="pre">show=admin</span></tt> : Administrator view with upload/download of <tt class="docutils literal"><span class="pre">config.xls</span></tt></li>
</ol>
</li>
<li>Footer : Show some more information if <tt class="docutils literal"><span class="pre">&amp;test</span></tt> is specified as a URL
parameter and the current user has <tt class="docutils literal"><span class="pre">test</span></tt> rights.</li>
</ol>
<p>The file <tt class="docutils literal"><span class="pre">cron.php</span></tt> finally contains code that can be run without any user
interaction and is normally executed from the operating system&#8217;s <a class="reference internal" href="installing.html#installing-cron"><em>job
scheduler</em></a>.</p>
</div>
<div class="section" id="globals-and-utilities">
<span id="globals-utilities"></span><h2>Globals and Utilities<a class="headerlink" href="#globals-and-utilities" title="Permalink to this headline">¶</a></h2>
<p>The following globals are noteworthy</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">$config</span></tt> : An <tt class="docutils literal"><span class="pre">ExcelConfig</span></tt> object &#8211; see file <tt class="docutils literal"><span class="pre">config.php</span></tt>. This
object is generated from the file <tt class="docutils literal"><span class="pre">instances/XXX/config/config.xls</span></tt></li>
<li><tt class="docutils literal"><span class="pre">$user</span></tt> : An array that is set to one of the values in <tt class="docutils literal"><span class="pre">$config-&gt;users</span></tt>
after successful login. With keys <tt class="docutils literal"><span class="pre">rights</span></tt> and <tt class="docutils literal"><span class="pre">access</span></tt> that describe
this users access permissions.</li>
<li><tt class="docutils literal"><span class="pre">$forms</span></tt> : An <tt class="docutils literal"><span class="pre">OdkDirectory</span></tt> object &#8211; see file <tt class="docutils literal"><span class="pre">odk_form.php</span></tt>. This
object is generated from the files <tt class="docutils literal"><span class="pre">instances/XXX/forms/*.xls</span></tt>. Every
object <tt class="docutils literal"><span class="pre">OdkForm</span></tt> in the dictionary <tt class="docutils literal"><span class="pre">$forms-&gt;forms</span></tt> contains information
about the form as described in its <tt class="docutils literal"><span class="pre">.xls</span></tt> file and can be used to read the
data from the database. See <a class="reference internal" href="#accessing-db"><em>Accessing the Database</em></a>.</li>
<li><tt class="docutils literal"><span class="pre">$show</span></tt> : The name of the current view (see above in <a class="reference internal" href="#hacking-overview"><em>Overview</em></a>).</li>
<li><tt class="docutils literal"><span class="pre">$hooks</span></tt> : Plugins use this object in order to <a class="reference internal" href="#developing-plugin"><em>install hooks</em></a>.</li>
</ul>
<p>And some utility functions</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">log_add($name,</span> <span class="pre">$message)</span></tt> : Adds a message to the specified <a class="reference internal" href="using.html#log-files"><em>log file</em></a>.</li>
<li><tt class="docutils literal"><span class="pre">alert($html,</span> <span class="pre">$class)</span></tt> : Displays the html snippet inside an alert box with
the given class (success, info, danger, error).</li>
<li><tt class="docutils literal"><span class="pre">profile_start($name)</span></tt> and <tt class="docutils literal"><span class="pre">profile_stop($name)</span></tt> : Measure time spent
for <tt class="docutils literal"><span class="pre">$name</span></tt> (can be called multiple times, e.g. inside a recursive
function). The footer displays the total time spent in every <tt class="docutils literal"><span class="pre">$name</span></tt>
(if the <tt class="docutils literal"><span class="pre">&amp;test</span></tt> URL parameter is specified).</li>
</ul>
</div>
<div class="section" id="accessing-the-database">
<span id="accessing-db"></span><h2>Accessing the Database<a class="headerlink" href="#accessing-the-database" title="Permalink to this headline">¶</a></h2>
<p>The file <tt class="docutils literal"><span class="pre">odk_form.php</span></tt> provides methods to access data in the ODK database
using identifiers from .xls files that were used as input to <a class="reference external" href="http://opendatakit.org/use/xlsform/">XLSForm</a>. Please
use the file&#8217;s <a class="reference external" href="../../api/files/odk_form.html">API doc</a> for reference.</p>
</div>
<div class="section" id="developing-a-plugin">
<span id="developing-plugin"></span><h2>Developing a Plugin<a class="headerlink" href="#developing-a-plugin" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">odk_planner</span></tt> comes with a simple plugin called <tt class="docutils literal"><span class="pre">doughnut</span></tt> that adds a page
with overview plots of data in the database.  This section will walk you step
by step through the creation of the <a class="reference internal" href="using.html#viewing-doughnut"><em>doughnut plugin</em></a>
that is the file <tt class="docutils literal"><span class="pre">plugins/doughnut.php</span></tt>.  The four steps outlined below
build successively on top of each other and introduce every time some new API to
give a quick an dirty introduction to the internals described above.  Note that
for every step the whole source code of the plugin is included.  Overwrite the
file <tt class="docutils literal"><span class="pre">plugins/doughnut.php</span></tt> with the source listing from the different steps
to see what changes and play around with the code.</p>
<p>The idea of this plugin is pretty simple : Specify fields and values in the
configuration (sheet <tt class="docutils literal"><span class="pre">doughnut</span></tt>) and let the plugin generate <a class="reference external" href="http://www.chartjs.org/docs/#doughnut-pie-chart">doughnut plots</a>
that show the distribution of the field of interest over the whole study
population.</p>
<div class="section" id="step-1-hooking">
<h3>Step 1 : Hooking<a class="headerlink" href="#step-1-hooking" title="Permalink to this headline">¶</a></h3>
<p>The plugin needs to hook into the normal program flow at multiple points.  First
it needs to include the javascript plotting library <a class="reference external" href="http://www.chartjs.org/">chart.js</a> into the header of
the html page.  Then it needs to change the menu (&#8220;augment the views&#8221;) with a
new menu entry <tt class="docutils literal"><span class="pre">doughnut</span></tt>.  And finally it needs to render the plots when the
view <tt class="docutils literal"><span class="pre">doughnut</span></tt> is active.</p>
<p>The file <tt class="docutils literal"><span class="pre">plugins.php</span></tt> lists some 10 different hooks together with an
explanation when they are called and the arguments.  In the code below we use
the three hooks <tt class="docutils literal"><span class="pre">dump_headers</span></tt> (to add <a class="reference external" href="http://www.chartjs.org/">chart.js</a>), <tt class="docutils literal"><span class="pre">augment_views</span></tt> (to add
the new menu point), and <tt class="docutils literal"><span class="pre">display</span></tt> (to render a static doughnut plot).</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="hll"><span class="k">function</span> <span class="nf">doughnut_dump_headers</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="k">echo</span> <span class="s1">&#39;&lt;script src=&quot;plugins/doughnut_chart.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="k">function</span> <span class="nf">doughnut_display</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="k">global</span> <span class="nv">$show</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$show</span> <span class="o">!==</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">        &lt;br&gt;&lt;br&gt;</span>
<span class="x">        &lt;div class=&quot;span12&quot;&gt;</span>
<span class="x">            &lt;center&gt;</span>
<span class="x">                &lt;canvas id=&quot;doughnut&quot; style=&quot;width:100%&quot;&gt;&lt;/canvas&gt;</span>
<span class="x">            &lt;/center&gt;</span>
<span class="x">            &lt;h4 style=&quot;text-align:center&quot;&gt;doughnut&lt;/h4&gt;</span>
<span class="x">            &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="x">                // Data copied from www.chartjs.org/docs/#doughnut-pie-chart</span>
<span class="x">                new Chart(document.getElementById(&#39;doughnut&#39;).getContext(&#39;2d&#39;))</span>
<span class="x">                    .Doughnut([{ value: 300, color:&quot;#F7464A&quot;, highlight: &quot;#FF5A5E&quot;, label: &quot;Red&quot; }, { value: 50, color: &quot;#46BFBD&quot;, highlight: &quot;#5AD3D1&quot;, label: &quot;Green&quot; }, { value: 100, color: &quot;#FDB45C&quot;, highlight: &quot;#FFC870&quot;, label: &quot;Yellow&quot; }]);</span>
<span class="x">            &lt;/script&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">&lt;?php</span>
<span class="p">}</span>

<span class="hll"><span class="k">function</span> <span class="nf">doughnut_augment_views</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="nv">$views</span> <span class="o">=&amp;</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">];</span>
    <span class="nb">array_push</span><span class="p">(</span><span class="nv">$views</span><span class="p">,</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="hll"><span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;dump_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_dump_headers&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;augment_views&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_augment_views&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_display&#39;</span><span class="p">);</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="step-2-access">
<h3>Step 2 : Access<a class="headerlink" href="#step-2-access" title="Permalink to this headline">¶</a></h3>
<p>We don&#8217;t want just any user to see our plugin, but only users with the
<tt class="docutils literal"><span class="pre">access</span></tt> right (as described in <a class="reference internal" href="configuring.html#user-sheet"><em>user configuration</em></a>).
This is easily implemented by checking for the right in the <tt class="docutils literal"><span class="pre">$user</span></tt> global
that contains the configuration for the currently logged in user.  We add the
check before rendering the plot but also when the menu is constructed so users
without the needed access right will neither see the plugin in the menu nor be
able to access the plot by manually tweaking the URL.</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">doughnut_dump_headers</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;&lt;script src=&quot;plugins/doughnut_chart.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_display</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$show</span><span class="p">,</span> <span class="nv">$user</span><span class="p">;</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$show</span> <span class="o">!==</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">        &lt;br&gt;&lt;br&gt;</span>
<span class="x">        &lt;div class=&quot;span12&quot;&gt;</span>
<span class="x">            &lt;center&gt;</span>
<span class="x">                &lt;canvas id=&quot;doughnut&quot; style=&quot;width:100%&quot;&gt;&lt;/canvas&gt;</span>
<span class="x">            &lt;/center&gt;</span>
<span class="x">            &lt;h4 style=&quot;text-align:center&quot;&gt;doughnut&lt;/h4&gt;</span>
<span class="x">            &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="x">                // Data copied from www.chartjs.org/docs/#doughnut-pie-chart</span>
<span class="x">                new Chart(document.getElementById(&#39;doughnut&#39;).getContext(&#39;2d&#39;))</span>
<span class="x">                    .Doughnut([{ value: 300, color:&quot;#F7464A&quot;, highlight: &quot;#FF5A5E&quot;, label: &quot;Red&quot; }, { value: 50, color: &quot;#46BFBD&quot;, highlight: &quot;#5AD3D1&quot;, label: &quot;Green&quot; }, { value: 100, color: &quot;#FDB45C&quot;, highlight: &quot;#FFC870&quot;, label: &quot;Yellow&quot; }]);</span>
<span class="x">            &lt;/script&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">&lt;?php</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_augment_views</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
</span>    <span class="nv">$views</span> <span class="o">=&amp;</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">];</span>
    <span class="nb">array_push</span><span class="p">(</span><span class="nv">$views</span><span class="p">,</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;dump_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_dump_headers&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;augment_views&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_augment_views&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_display&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="step-3-configuration">
<h3>Step 3 : Configuration<a class="headerlink" href="#step-3-configuration" title="Permalink to this headline">¶</a></h3>
<p>This snippet iterates through the configuration key/value pairs in the lines
<tt class="docutils literal"><span class="pre">54-63</span></tt>.  Every value is parsed with the new function <tt class="docutils literal"><span class="pre">doughnut_config</span></tt>
(by the way : it&#8217;s good practise to prepend all functions in the plugin with
the plugins name to avoid name space collisions).  If an error occurs during the
parsing (quite possible since Excel lets you save just about any invalid setting
imaginable) the doughnut is not rendered for that row and an error is displayed
to the user.</p>
<p>The function <tt class="docutils literal"><span class="pre">doughnut_config</span></tt> expects value that specifies the field of
interest and the form this field can be found in (<tt class="docutils literal"><span class="pre">FORM\FIELD</span></tt>).  The form is
then looked up in the global associative array <tt class="docutils literal"><span class="pre">$forms-&gt;forms</span></tt> and the
specified field is verified to exist in the <tt class="docutils literal"><span class="pre">$form-&gt;mapping</span></tt> (read more
<a class="reference internal" href="#accessing-db"><em>above</em></a>).  The name of the MySQL table and column that
represent the field are then returned and used in the next step to extract the
data from the MySQL database.</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">doughnut_dump_headers</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;&lt;script src=&quot;plugins/doughnut_chart.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_render</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$id</span> <span class="o">=</span> <span class="s1">&#39;doughnut_&#39;</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">        &lt;br&gt;&lt;br&gt;</span>
<span class="x">        &lt;div class=&quot;span12&quot;&gt;</span>
<span class="x">            &lt;center&gt;</span>
<span class="x">                &lt;canvas id=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$id</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&quot; style=&quot;width:100%&quot;&gt;&lt;/canvas&gt;</span>
<span class="x">            &lt;/center&gt;</span>
<span class="x">            &lt;h4 style=&quot;text-align:center&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$name</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&lt;/h4&gt;</span>
<span class="x">            &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="x">                // Data copied from www.chartjs.org/docs/#doughnut-pie-chart</span>
<span class="x">                new Chart(document.getElementById(&#39;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$id</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&#39;).getContext(&#39;2d&#39;))</span>
<span class="x">                    .Doughnut([{ value: 300, color:&quot;#F7464A&quot;, highlight: &quot;#FF5A5E&quot;, label: &quot;Red&quot; }, { value: 50, color: &quot;#46BFBD&quot;, highlight: &quot;#5AD3D1&quot;, label: &quot;Green&quot; }, { value: 100, color: &quot;#FDB45C&quot;, highlight: &quot;#FFC870&quot;, label: &quot;Yellow&quot; }]);</span>
<span class="x">            &lt;/script&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">&lt;?php</span>
<span class="p">}</span>

<span class="hll"><span class="k">function</span> <span class="nf">doughnut_config</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">global</span> <span class="nv">$forms</span><span class="p">;</span>
</span><span class="hll">    <span class="c1">// We only expect one part but allow more values for later versions.</span>
</span><span class="hll">    <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;expected &quot;FORM\\FIELD ...&quot;&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="nv">$form_field</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$form_field</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;expected &quot;FORM\\FIELD ...&quot;&#39;</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1">// $forms-&gt;forms is array that maps formid to OdkForm (see odk_form.php).</span>
</span><span class="hll">    <span class="nv">$form</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$forms</span><span class="o">-&gt;</span><span class="na">forms</span><span class="p">[</span><span class="nv">$form_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;unknown form &quot;&#39;</span> <span class="o">.</span> <span class="nv">$form_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="c1">// OdkForm::mapping maps form field to table/column (see odk_form.php).</span>
</span><span class="hll">    <span class="nv">$table_column</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">mapping</span><span class="p">[</span><span class="nv">$form_field</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$table_column</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;unknown field &quot;&#39;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nv">$form_field</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
</span><span class="hll">        <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table_column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class="hll">        <span class="s1">&#39;column&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table_column</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="k">function</span> <span class="nf">doughnut_display</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$show</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$show</span> <span class="o">!==</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// Parse doughnut config lines.</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">plugins</span><span class="p">[</span><span class="s1">&#39;doughnut&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$name</span><span class="o">=&gt;</span><span class="nv">$config_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$config_or_error</span> <span class="o">=</span> <span class="nx">doughnut_config</span><span class="p">(</span><span class="nv">$config_string</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">gettype</span><span class="p">(</span><span class="nv">$config_or_error</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Function returns string in case of parse error.</span>
<span class="hll">            <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Error config doughnut &#39;</span> <span class="o">.</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39; : &#39;</span> <span class="o">.</span>
</span><span class="hll">                  <span class="nv">$config_or_error</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">doughnut_render</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$config_or_error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_augment_views</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nv">$views</span> <span class="o">=&amp;</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">];</span>
    <span class="nb">array_push</span><span class="p">(</span><span class="nv">$views</span><span class="p">,</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;dump_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_dump_headers&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;augment_views&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_augment_views&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_display&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="step-4-data">
<h3>Step 4 : Data<a class="headerlink" href="#step-4-data" title="Permalink to this headline">¶</a></h3>
<p>Having all the necessary hooks, the doughnut plot, some access control and the
configuration parsing in place, the only thing that need to be done is to
connect the plot to the actual data from the database.</p>
<p>The function <tt class="docutils literal"><span class="pre">doughnut_query</span></tt> constructs a MySQL query using the MySQL table
and column name.  The query has the following form:</p>
<div class="highlight-python"><pre>SELECT column AS value, COUNT(column) AS count
FROM table GROUP BY column ORDER BY column</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">column</span></tt> and <tt class="docutils literal"><span class="pre">table</span></tt> will be replace with the actual values.  If the
query were generated for the field <tt class="docutils literal"><span class="pre">LRF1\COLONY_COUNT</span></tt> from the example
dataset, the following table would be the reply from the query:</p>
<table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">value</th>
<th class="head">count</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>negative</td>
<td>3</td>
</tr>
<tr class="row-odd"><td>1+</td>
<td>2</td>
</tr>
<tr class="row-even"><td>2+</td>
<td>3</td>
</tr>
<tr class="row-odd"><td>3+</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>The function <tt class="docutils literal"><span class="pre">doughnot_json</span></tt> merely translates the MySQL result to a JSON
in the format expected by <a class="reference external" href="http://www.chartjs.org/">chart.js</a>.  Note that we call <tt class="docutils literal"><span class="pre">mysql_query_</span></tt> so the
query gets logged (calling the standard <tt class="docutils literal"><span class="pre">mysql_query</span></tt> would also work fine).
If MySQL returns an error no plot is displayed but the error is shown to the
user by calling <tt class="docutils literal"><span class="pre">alert</span></tt> (from <tt class="docutils literal"><span class="pre">util.php</span></tt>).</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">doughnut_dump_headers</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;&lt;script src=&quot;plugins/doughnut_chart.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="k">function</span> <span class="nf">doughnut_query</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;SELECT $column AS value, COUNT($column) AS count &#39;</span> <span class="o">.</span>
</span><span class="hll">             <span class="s1">&#39;FROM $table GROUP BY $column ORDER BY $column&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="nv">$query</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;$table&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">],</span> <span class="nv">$query</span><span class="p">);</span>
</span><span class="hll">    <span class="nv">$query</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;$column&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="nv">$query</span><span class="p">);</span>
</span><span class="hll">    <span class="k">return</span> <span class="nv">$query</span><span class="p">;</span>
</span><span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_json</span><span class="p">(</span><span class="nv">$curs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">];</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$curs</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">array_push</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
            <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;color&#39;</span> <span class="o">=&gt;</span> <span class="nv">$colors</span><span class="p">[</span><span class="nv">$i</span><span class="o">++</span> <span class="o">%</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$colors</span><span class="p">)]</span>
        <span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_render</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$conn</span><span class="p">;</span>

    <span class="nv">$id</span> <span class="o">=</span> <span class="s1">&#39;doughnut_&#39;</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="nv">$query</span> <span class="o">=</span> <span class="nx">doughnut_query</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
<span class="hll">    <span class="nv">$curs</span> <span class="o">=</span> <span class="nx">mysql_query_</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$conn</span><span class="p">);</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nv">$curs</span> <span class="o">===</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;MySQL error : &#39;</span> <span class="o">.</span> <span class="nb">mysql_error</span><span class="p">(),</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>    <span class="nv">$json</span> <span class="o">=</span> <span class="nx">doughnut_json</span><span class="p">(</span><span class="nv">$curs</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="x">        &lt;br&gt;&lt;br&gt;</span>
<span class="x">        &lt;div class=&quot;span12&quot;&gt;</span>
<span class="x">            &lt;center&gt;</span>
<span class="x">                &lt;canvas id=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$id</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&quot; style=&quot;width:100%&quot;&gt;&lt;/canvas&gt;</span>
<span class="x">            &lt;/center&gt;</span>
<span class="x">            &lt;h4 style=&quot;text-align:center&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$name</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&lt;/h4&gt;</span>
<span class="x">            &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="x">                // See www.chartjs.org/docs/#doughnut-pie-chart</span>
<span class="x">                new Chart(document.getElementById(&#39;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$id</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&#39;).getContext(&#39;2d&#39;))</span>
<span class="hll"><span class="x">                    .Doughnut(</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$json</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">);</span>
</span><span class="x">            &lt;/script&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">&lt;?php</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_config</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$forms</span><span class="p">;</span>
    <span class="c1">// We only expect one part but allow more values for later versions.</span>
    <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;expected &quot;FORM\\FIELD ...&quot;&#39;</span><span class="p">;</span>
    <span class="nv">$form_field</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$form_field</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;expected &quot;FORM\\FIELD ...&quot;&#39;</span><span class="p">;</span>

    <span class="c1">// $forms-&gt;forms is array that maps formid to OdkForm (see odk_form.php).</span>
    <span class="nv">$form</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$forms</span><span class="o">-&gt;</span><span class="na">forms</span><span class="p">[</span><span class="nv">$form_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;unknown form &quot;&#39;</span> <span class="o">.</span> <span class="nv">$form_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
    <span class="c1">// OdkForm::mapping maps form field to table/column (see odk_form.php).</span>
    <span class="nv">$table_column</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">mapping</span><span class="p">[</span><span class="nv">$form_field</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$table_column</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;unknown field &quot;&#39;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="nv">$form_field</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table_column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;column&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table_column</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_display</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$show</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$show</span> <span class="o">!==</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// Parse doughnut config lines.</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">plugins</span><span class="p">[</span><span class="s1">&#39;doughnut&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$name</span><span class="o">=&gt;</span><span class="nv">$config_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$config_or_error</span> <span class="o">=</span> <span class="nx">doughnut_config</span><span class="p">(</span><span class="nv">$config_string</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">gettype</span><span class="p">(</span><span class="nv">$config_or_error</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Function returns string in case of parse error.</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Error config doughnut &#39;</span> <span class="o">.</span> <span class="nv">$name</span> <span class="o">.</span> <span class="s1">&#39; : &#39;</span> <span class="o">.</span>
                  <span class="nv">$config_or_error</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">doughnut_render</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$config_or_error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">doughnut_augment_views</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nv">$views</span> <span class="o">=&amp;</span> <span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">];</span>
    <span class="nb">array_push</span><span class="p">(</span><span class="nv">$views</span><span class="p">,</span> <span class="s1">&#39;doughnut&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;dump_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_dump_headers&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;augment_views&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_augment_views&#39;</span><span class="p">);</span>
<span class="nv">$hooks</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;doughnut_display&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="step-5-bucketing">
<h3>Step 5 : Bucketing<a class="headerlink" href="#step-5-bucketing" title="Permalink to this headline">¶</a></h3>
<p>Now compare the source from the last step with the plugin as included in the
<tt class="docutils literal"><span class="pre">plugins/doughnut.php</span></tt> (if you overwrite it get it back from github:
<a class="reference external" href="https://github.com/SwissTPH/odk_planner/blob/master/plugins/doughnut.php">doughnut.php</a>).  The configuration was extended to list possible values after
<tt class="docutils literal"><span class="pre">FORM\FIELD</span></tt>.  If these values have the form of a range of numbers (e.g.
<tt class="docutils literal"><span class="pre">10-20</span></tt>) then the MySQL query will summarize the values of some ordinal
datapoint into the buckets thus specified.</p>
<p>By the way : there is also a simple test suite for this plugin.  The file
<tt class="docutils literal"><span class="pre">test/test_doughnut.py</span></tt> checks that the access restrictions work as expected,
that the configuration parsing alerts user if invalid values are specified, and
that a new plot can be added modifying the configuration.</p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="Tutorial"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013, Andreas Steiner.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'v0.11',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
